\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{newrevisor}[2022/04/13 v0.4 newrevisor]
% A LaTeX style file for providing comments and revising text
%
% Author: Manuel Lopez-Ibanez  <manuel.lopez-ibanez@manchester.ac.uk>
%
% This package defines 2 commands:
% 
% 1. `\newrevisor{name}{color-for-insert}[color-for-delete]` where the first
%    argument is the name of the revisor, second argument is color for additions
%    and third optional argument is color for deletions. If the third argument is
%    missing, the second argument is used for both additions and deletions.  See
%    colornames in https://en.wikibooks.org/wiki/LaTeX/Colors
%    
%   This command creates two new commands:
%   
%   * Lowercase `\name{text-to-delete}{text-to-insert}` for suggesting changes.
%   
%   * Uppercase `\NAME{text}` for adding comments.
%   
% 2. `\hiderevisor{name}` Disables the corresponding commands generated by
%    `\newrevisor{name}`, that is, removes comments and suggested deletions and
%    shows suggested additions without coloring them.
% 
\PassOptionsToPackage{dvipsnames}{xcolor}
\RequirePackage{xparse}
\RequirePackage{xcolor}
\PassOptionsToPackage{normalem}{ulem}
\RequirePackage{ulem}
\RequirePackage{iftex}
\RequirePackage{hyperref}
\RequirePackage{relsize}
\RequirePackage{kvoptions}
\SetupKeyvalOptions{
  family=REVISOR,
  prefix=REVISOR@
}
\DeclareBoolOption{todonotes} % use todonotes instead of footnotes
\DeclareStringOption{hide}[before] % hide=before hide=after
\def\REVISOR@before{before}
\def\REVISOR@after{after}
\DeclareBoolOption{inline} % inline comments
\ProcessKeyvalOptions*

%% Revision commands
\ifx\REVISOR@hide\@empty
\else
\ifx\REVISOR@before\REVISOR@hide
\newcommand{\newrevisor@SuggestEdit}[4]{#2}
\else
\ifx\REVISOR@after\REVISOR@hide
\newcommand{\newrevisor@SuggestEdit}[4]{#1}
\else
\PackageError{\@currname}{Unknown value for option 'hide='. Valid values are 'before' or 'after'}{Unknown value for option 'hide='. Valid values are 'before' or 'after'}
% We set this so we can continue without throwing more errors.
\let\REVISOR@hide\@empty
\fi
\fi
\fi

% FIXME: \sout is not very good. It cannot handle commands within its argument.
\ifx\REVISOR@hide\@empty
\DeclareRobustCommand{\mysout}[1]{%
  \LetLtxMacro\origcite\cite%
  \renewcommand{\cite}[2][]{\mbox{\origcite[##1]{##2}}}%
  %\makeatletter%
  \@ifundefined{citet}{}{%
    \LetLtxMacro\origcitet\citet%
    \renewcommand{\citet}[2][]{\mbox{\origcitet[##1]{##2}}}%
  }%
  \@ifundefined{citep}{}{%
    \LetLtxMacro\origcitep\citep%
    \renewcommand{\citep}[2][]{\mbox{\origcitep[##1]{##2}}}%
  }%
  %\makeatother%
  \texorpdfstring{\ifmmode\text{\sout{\ensuremath{#1}}}\else\sout{#1}\fi}{#1}}%
\newcommand{\newrevisor@SuggestEdit}[4]{{\color{#3}\hypersetup{citecolor=#3}\mysout{#1}}{\color{#4}\hypersetup{citecolor=#4}#2}}%
\fi % no hide

\ifREVISOR@todonotes
  \ifx\REVISOR@hide\@empty
    \PassOptionsToPackage{textsize=tiny,prependcaption}{todonotes}
  \else
    \PassOptionsToPackage{disable}{todonotes}
  \fi % hide
  \RequirePackage{todonotes}
  \newcommand{\newrevisor@RevInlineComment}[3][red]{%
    \colorlet{tmpcolor}{#1}%
    \todo[inline,color=tmpcolor!29, bordercolor=tmpcolor!47, caption={\textbf{#2}}]{#3}}
  \newcommand{\newrevisor@RevComment}[3][red]{%
    \colorlet{tmpcolor}{#1}%
    \todo[color=tmpcolor!29, bordercolor=tmpcolor!47, caption={\textbf{#2}}]{#3}}
  % % some fancy todos
  % % \usepackage[colorinlistoftodos, prependcaption, textwidth=2cm, textsize=tiny]{todonotes}
  % \usepackage[colorinlistoftodos, prependcaption, textwidth=2cm, textsize=tiny]{todonotes}
  % \setuptodonotes{color=blue!29, bordercolor=blue!47}
  % \newcommandx{\ourtodo}[4][4=,usedefault]{\todo[color=#3!29, inline, bordercolor=#3!47, caption={\textbf{#4} #1}]{#2}}
  % \newcommand{\nayat}[1]{\ourtodo{Nayat}{#1}{purple}}
  % \newcommand{\arnaud}[1]{\ourtodo{Arnaud}{#1}{magenta}}
  % \newcommand{\luis}[1]{\ourtodo{Luis}{#1}{green}}
  % \newcommand{\manuel}[1]{\ourtodo{Manuel}{#1}{orange}}
  % \newcommand{\leslie}[1]{\ourtodo{Leslie}{#1}{magenta}}
  % \newcommand{\pedro}[1]{\ourtodo{Pedro}{#1}{red}}
  % \newcommand{\suggestion}[1]{\todo[inline, nolist, bordercolor=gray!47, color=gray!29, size=\tiny]{#1}}
\else
  \let\svthefootnote\thefootnote
  \newcommand\colorfootnote[2][black]{\def\thefootnote{\color{#1}\svthefootnote}%
    \footnote{\color{#1}#2}\def\thefootnote{\color{black}\svthefootnote}}
  %% TODO: Make this a package option
  %% A different implementation in case the above one does not work, not sure which one is better
  % \makeatletter
  % \let\sv@makefnmark\@makefnmark
  % \newcommand\colorfootnote[2][black]{\renewcommand\@makefnmark{\color{#1}\sv@makefnmark}\footnote{\protect{\color{#1}#2}}\renewcommand\@makefnmark{\sv@makefnmark}}
  % \makeatother
  \ifx\REVISOR@hide\@empty
    \newcommand\newrevisor@RevInlineComment[3][red]{\hskip 0pt\begingroup\color{#1}\footnotesize\bfseries[{\smaller #2}: #3]\endgroup}
      \newcommand\newrevisor@RevComment[3][red]{\protect\colorfootnote[#1]{{\textbf{[{\smaller #2}: #3]}}}}
  \else
    \newcommand\newrevisor@RevInlineComment[3][red]{}
    \newcommand{\newrevisor@RevComment}[3][red]{}
  \fi % hide
\fi % todonotes
\ifREVISOR@inline
  \renewcommand\newrevisor@RevComment{\newrevisor@RevInlineComment}
\fi % inline

% Creates a command for edits in lowercase (delete, add) in lowercase and a command in UPPERCASE for commenting, second argument is a color
\newcommand\newrevisor@twocolors[3]{%%
  %\colorlet{#1}{#2}%
  \expandafter\DeclareRobustCommand\csname#1\endcsname[2]{\newrevisor@SuggestEdit{##1}{##2}{#3}{#2}}%%
  \uppercase{\expandafter\NewDocumentCommand\csname#1}\endcsname{sm}{%
    \IfBooleanTF##1%
      % with star: inline
      {\newrevisor@RevInlineComment[#2]{\MakeUppercase{#1}}{##2}}%
      % without star: footnote
      {\newrevisor@RevComment[#2]{\MakeUppercase{#1}}{##2}}%
    }%%
}

\newcommand\hiderevisor[1]{%%
  \expandafter\renewcommand\csname#1\endcsname[2]{}%%
  \uppercase{\expandafter\RenewDocumentCommand\csname#1}\endcsname{so}{}%
}
%% Handle different colors for deletion and adding
\NewDocumentCommand{\newrevisor}{mmO{#2}}{\newrevisor@twocolors{#1}{#2}{#3}}
% First argument is the desired command name, second argument is color for
% additions, third optional argument is color for deletions. If the third
% argument is missing, the second argument is used for both additions and
% deletions.  See colornames in https://en.wikibooks.org/wiki/LaTeX/Colors
%
% This example creates lowercase \manuel{TEXT-TO-DELETE}{TEXT-TO-ADD} and uppercase \MANUEL{COMMENT TEXT}. Use the starred version \MANUEL*{COMMENT TEXT} to force the comment to be inline (for footnotes, captions, tables, etc.)
% \newrevisor{manuel}{violet!75}
% \hiderevisor{manuel}

\endinput
